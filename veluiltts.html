<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veluil TTS Engine</title>
    <style>
        body { 
            background-color: #000; 
            color: #0f0; 
            font-family: 'Courier New', Courier, monospace; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .container { 
            width: 90%; 
            max-width: 650px; 
            border: 2px solid #0f0; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 0 20px #0f0; 
        }
        h2 { 
            text-align: center; 
            color: #0f0; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            margin-bottom: 25px;
        }
        textarea { 
            width: 100%; 
            height: 150px; 
            background: #111; 
            color: #fff; 
            border: 1px solid #0f0; 
            padding: 15px; 
            box-sizing: border-box; 
            font-size: 1.4rem; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            outline: none; 
            resize: none;
        }
        button { 
            background-color: #0f0; 
            color: #000; 
            border: none; 
            padding: 20px; 
            cursor: pointer; 
            font-weight: bold; 
            width: 100%; 
            font-size: 1.5rem; 
            border-radius: 5px; 
            text-transform: uppercase; 
        }
        button:hover { 
            background-color: #fff; 
            box-shadow: 0 0 15px #fff; 
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Veluil TTS Engine</h2>
    <textarea id="input" placeholder="Only 'Enter' will pause"></textarea>
    <button id="speakBtn">Speak</button>
</div>

<script>
  alert('pls check about your browser support TTS. if you didnt input veluil text then this is not work')
    const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
    const JUNG = ['ㅏ','ㅐ','ㅑ','ㅒ','ㅓ','ㅔ','ㅕ','ㅖ','ㅗ','ㅘ','ㅙ','ㅚ','ㅛ','ㅜ','ㅝ','ㅞ','ㅟ','ㅠ','ㅡ','ㅢ','ㅣ'];
    const JONG = ['', 'ㄱ','ㄲ','ㄳ','ㄴ','ㄵ','ㄶ','ㄷ','ㄹ','ㄺ','ㄻ','ㄼ','ㄽ','ㄾ','ㄿ','ㅀ','ㅁ','ㅂ','ㅄ','ㅅ','ㅆ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];

    const veluilConsonant = ['ㅁ','ㅂ','ㄷ','ㄱ','ㄴ','ㄹ','ㅃ','ㄸ','ㄲ','ㅍ','ㅌ','ㅋ','ㅈ','ㅉ','ㅊ','ㅅ'];
    const veluilVowel = [
        {v:'ㅜ', c:''},   {v:'ㅗ', c:''},   {v:'ㅓ', c:''},   {v:'ㅡ', c:''},
        {v:'ㅏ', c:''},   {v:'ㅐ', c:''},   {v:'ㅣ', c:''},   {v:'ㅝ', c:''},
        {v:'ㅜ', c:'ㅁ'}, {v:'ㅗ', c:'ㅁ'}, {v:'ㅓ', c:'ㅁ'}, {v:'ㅡ', c:'ㅁ'},
        {v:'ㅏ', c:'ㅁ'}, {v:'ㅐ', c:'ㅁ'}, {v:'ㅣ', c:'ㅁ'}, {v:'ㅙ', c:''}
    ];
    const alphabet = "abcdefghijklmnop";

    function combine(choChar, jungChar, jongChar = '') {
        const choIdx = CHO.indexOf(choChar);
        const jungIdx = JUNG.indexOf(jungChar);
        const jongIdx = JONG.indexOf(jongChar || '');
        if (choIdx === -1 || jungIdx === -1) return choChar + (jungChar || '') + (jongChar || '');
        return String.fromCharCode(44032 + (choIdx * 588) + (jungIdx * 28) + (jongIdx === -1 ? 0 : jongIdx));
    }

    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function process() {
        const rawValue = document.getElementById('input').value.toLowerCase();
        
        // 엔터(\n)를 기준으로만 토큰을 분리함
        const tokens = rawValue.split(/(\n)/);
        
        window.speechSynthesis.cancel();

        for (let i = 0; i < tokens.length; i++) {
            let token = tokens[i];

            // 엔터 기호인 경우에만 0.5초 대기
            if (token === '\n') {
                await delay(500); 
                continue;
            }

            // 알파벳이 아닌 모든 문자(공백, 마침표 등)를 제거하여 한 덩어리로 만듦
            let cleanToken = token.replace(/[^a-p]/g, '');
            if (!cleanToken) continue;

            let wordResult = "";
            let chars = cleanToken.split('');
            let syllables = [];

            for (let j = 0; j < chars.length; j += 2) {
                if (!chars[j+1]) break;
                syllables.push({
                    onset: veluilConsonant[alphabet.indexOf(chars[j])],
                    vowel: veluilVowel[alphabet.indexOf(chars[j+1])].v,
                    coda: veluilVowel[alphabet.indexOf(chars[j+1])].c,
                    vowelChar: chars[j+1]
                });
            }

            for (let j = 0; j < syllables.length; j++) {
                let cur = syllables[j];
                let next = syllables[j+1];

                if (cur.coda === 'ㅁ' && next && next.vowelChar === 'a') {
                    let mappedCoda = '';
                    let shouldAbsorb = false;
                    switch(next.onset) {
                        case 'ㄱ': mappedCoda = 'ㄱ'; shouldAbsorb = true; break;
                        case 'ㅂ': mappedCoda = 'ㅂ'; shouldAbsorb = true; break;
                        case 'ㅃ': mappedCoda = 'ㅇ'; shouldAbsorb = true; break;
                        case 'ㄷ': mappedCoda = 'ㄷ'; shouldAbsorb = true; break;
                        case 'ㄴ': mappedCoda = 'ㄴ'; shouldAbsorb = true; break;
                        case 'ㄹ': mappedCoda = 'ㄹ'; shouldAbsorb = true; break;
                    }
                    if (shouldAbsorb) {
                        wordResult += combine(cur.onset, cur.vowel, mappedCoda);
                        j++; continue;
                    }
                }
                wordResult += combine(cur.onset, cur.vowel, cur.coda);
            }

            if (wordResult) {
                await speakText(wordResult);
            }
        }
    }

    function speakText(text) {
        return new Promise((resolve) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.0;
            utterance.onend = resolve;
            window.speechSynthesis.speak(utterance);
        });
    }

    document.getElementById('speakBtn').addEventListener('click', process);
</script>

</body>
</html>
